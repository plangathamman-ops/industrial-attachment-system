name: Build and Push to AWS ECR

on:
	push:
		branches: [ main, master ]
	workflow_dispatch:

env:
	AWS_REGION: us-east-1
	ECR_REPOSITORY_BACKEND: industrial-attachment-backend
	ECR_REPOSITORY_FRONTEND: industrial-attachment-frontend

jobs:
	build-and-push:
		name: Build and Push Docker Images
		runs-on: ubuntu-latest
    
		steps:
		- name: Checkout code
			uses: actions/checkout@v3

		- name: Configure AWS credentials
			uses: aws-actions/configure-aws-credentials@v2
			with:
				aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
				aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
				aws-region: ${{ env.AWS_REGION }}

		- name: Login to Amazon ECR
			id: login-ecr
			uses: aws-actions/amazon-ecr-login@v1

		- name: Build, tag, and push backend image to Amazon ECR
			env:
				ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
				IMAGE_TAG: ${{ github.sha }}
			run: |
				cd backend
				docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:$IMAGE_TAG .
				docker tag $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:latest
				docker push $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:$IMAGE_TAG
				docker push $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:latest

		- name: Build, tag, and push frontend image to Amazon ECR
			env:
				ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
				IMAGE_TAG: ${{ github.sha }}
			run: |
				cd frontend
				docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:$IMAGE_TAG .
				docker tag $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:latest
				docker push $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:$IMAGE_TAG
				docker push $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:latest

		- name: Image digests
			env:
				ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
				IMAGE_TAG: ${{ github.sha }}
			run: |
				echo "Backend image: $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:$IMAGE_TAG"
				echo "Frontend image: $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:$IMAGE_TAG"
				echo "âœ… Images pushed successfully!"

